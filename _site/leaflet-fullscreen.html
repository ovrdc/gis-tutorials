<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Map Intro</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Leaflet -->
	<link rel="stylesheet" href="map-plugins/leaflet/leaflet.css" />
	<script src="map-plugins/leaflet/leaflet.js"></script>
	<script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-hash/v0.2.1/leaflet-hash.js"></script>
	<!-- Omnivore -->
	<script src="map-plugins/omnivore/leaflet-omnivore.min.js"></script>
	<!-- Search -->
	<link rel="stylesheet" href="map-plugins/search/leaflet-search.min.css" />
	<script src="map-plugins/search/leaflet-search.min.js"></script>
	<!--Choropleth -->
	<script src="map-plugins/choropleth/choropleth.js"></script>
	<!--Turf -->
	<script src="map-plugins/turf/turf.min.js"></script>
	<style>
		body,html{
			height:100%;
			width:100%;
			margin:0;
		}
		#map{
			width:100%;
			height:100%;
			background:whitesmoke;
		}
  </style>
</head>
<body>
<div id="map"></div>
<script>
var map = L.map("map");

map.setView([40.3,-96.6], 5);

L.hash(map);

L.control.scale().addTo(map);

var layerControl = L.control.layers().addTo(map);

var url = "map-data/counties.topojson";

var counties = L.geoJson(null, {
    style: function(feature) {
	switch(feature.properties.winner) {
	    case "Trump": return {fillColor: "red"}
	    default	: return {fillColor: "blue"}
	}
    },
    onEachFeature: function(feature, county) {
	var info = county.feature.properties.NAME +
        "<br>" + county.feature.properties.winner;
    county.bindPopup(info);
    }
});

layerControl.addOverlay(counties, "Counties");

var cData = omnivore.topojson(url, null, counties);

// Once our county data is loaded,
// add search functionality using
// leaflet-search with default settings

var choropleth;

// Choropleth

cData.on("ready", function() {
	map.removeLayer(counties);
	choropleth = L.choropleth(cData.toGeoJSON(), {
		valueProperty: "POP_SQMI", // which property in the features to use
		scale: ["white","#006d2c"], // chroma.js scale - include as many as you like
		steps: 7, // number of breaks or steps in range
		mode: "q", // q for quantile, e for equidistant, k for k-means
		style: {
			color: "#fff", // border color
			weight: 1,
			fillOpacity: 0.9
		},
		onEachFeature: function(feature, layer) {
			layer.bindTooltip(feature.properties.NAME + "<br>" + feature.properties.POPULATION)
		}
	}).addTo(map);
	layerControl.addOverlay(choropleth, "Choropleth");
});

var url2= "map-data/airports.geojson"

var aStyle= {
    color: "black",
    radius: 5,
    weight: 0,
    fillOpacity: 1,
    pane: "markerPane" };

var airports = L.geoJson(null, {
    pointToLayer: function(feature, latlng) {
	return L.circleMarker(latlng, aStyle)
    }
}).addTo(map);

var aData= omnivore.geojson(url2, null, airports);

var airportJson;

aData.on('ready', function() {
    aData.toGeoJSON();
    airportJson = aData.toGeoJSON();
});

var highlightStyle = {
    color: "goldenrod",
    fillColor: "goldenrod",
    opacity: 1,
    fillOpacity: 1,
    pane: "markerPane"
}

var highlight = new L.geoJson(null, {
    pointToLayer: function(feature, latlng) {
	return new L.circleMarker(latlng, highlightStyle)
    }
}).addTo(map);

counties.on("mouseover", function(e) {
    highlight.clearLayers();
    var selLayer = new L.geoJson(e.layer.toGeoJSON());
    var within = turf.within(airportJson, selLayer.toGeoJSON());
    highlight.addData(within);
});
</script>
</body>
</html>
